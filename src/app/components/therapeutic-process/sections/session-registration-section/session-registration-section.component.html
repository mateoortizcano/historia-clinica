<div class="section-container">
  <!-- Header with Action Button -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
    <div class="flex-grow-1">
      <h3 class="section-title mb-2">
        <i class="bi bi-calendar2-week me-2"></i>
        Registro de Sesiones
      </h3>
      <p class="section-description mb-0">
        @if (readOnly()) {
          Historial completo de sesiones realizadas durante el proceso terapéutico.
        } @else {
          Registre cada sesión o cita con el paciente. Las sesiones quedan registradas permanentemente para mantener la integridad del historial clínico.
        }
      </p>
    </div>
    
    <!-- Botón para agregar nueva sesión -->
    @if (!showForm() && !readOnly()) {
      <div class="flex-shrink-0">
        <button
          type="button"
          class="btn btn-success"
          (click)="startNewSession()"
        >
          <i class="bi bi-plus-circle me-2"></i>
          {{ sessionsCount() === 0 ? 'Registrar Primera Sesión' : 'Agregar Nueva Sesión' }}
        </button>
      </div>
    }
  </div>

  <!-- Formulario de sesión -->
  @if (showForm()) {
    <div class="session-form card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-plus-circle me-2"></i>
          Nueva Sesión
        </h5>
      </div>
      <div class="card-body">
        <form [formGroup]="form">
          <div class="row g-3">
            <!-- Número de sesión -->
            <div class="col-md-4">
              <label for="sessionNumber" class="form-label required">Número de Sesión</label>
              <input
                type="number"
                id="sessionNumber"
                formControlName="sessionNumber"
                class="form-control"
                [class.is-invalid]="form.get('sessionNumber')?.invalid && form.get('sessionNumber')?.touched"
                readonly
              />
            </div>

            <!-- Fecha -->
            <div class="col-md-4">
              <label for="date" class="form-label required">Fecha</label>
              <input
                type="date"
                id="date"
                formControlName="date"
                class="form-control"
                [class.is-invalid]="form.get('date')?.invalid && form.get('date')?.touched"
              />
              @if (form.get('date')?.invalid && form.get('date')?.touched) {
                <div class="invalid-feedback">La fecha es requerida</div>
              }
            </div>

            <!-- Hora -->
            <div class="col-md-4">
              <label for="time" class="form-label required">Hora</label>
              <input
                type="time"
                id="time"
                formControlName="time"
                class="form-control"
                [class.is-invalid]="form.get('time')?.invalid && form.get('time')?.touched"
              />
              @if (form.get('time')?.invalid && form.get('time')?.touched) {
                <div class="invalid-feedback">La hora es requerida</div>
              }
            </div>

            <!-- Objetivos y Técnicas -->
            <div class="col-12">
              <label for="objectivesAndTechniques" class="form-label required">
                Objetivos / Técnicas - Instrumentos
              </label>
              <textarea
                id="objectivesAndTechniques"
                formControlName="objectivesAndTechniques"
                class="form-control"
                [class.is-invalid]="form.get('objectivesAndTechniques')?.invalid && form.get('objectivesAndTechniques')?.touched"
                rows="4"
                maxlength="2000"
                placeholder="Describa los objetivos de la sesión y las técnicas o instrumentos utilizados"
              ></textarea>
              @if (form.get('objectivesAndTechniques')?.invalid && form.get('objectivesAndTechniques')?.touched) {
                <div class="invalid-feedback">
                  Este campo es requerido (máximo 2000 caracteres)
                </div>
              }
              <div class="form-text">
                {{ form.get('objectivesAndTechniques')?.value?.length || 0 }}/2000 caracteres
              </div>
            </div>

            <!-- Descripción de la sesión -->
            <div class="col-12">
              <label for="sessionDescription" class="form-label required">
                Descripción de la Sesión
              </label>
              <textarea
                id="sessionDescription"
                formControlName="sessionDescription"
                class="form-control"
                [class.is-invalid]="form.get('sessionDescription')?.invalid && form.get('sessionDescription')?.touched"
                rows="8"
                maxlength="5000"
                placeholder="Describa detalladamente lo ocurrido durante la sesión, observaciones relevantes, respuesta del paciente a las intervenciones, etc."
              ></textarea>
              @if (form.get('sessionDescription')?.invalid && form.get('sessionDescription')?.touched) {
                <div class="invalid-feedback">
                  Este campo es requerido (máximo 5000 caracteres)
                </div>
              }
              <div class="form-text">
                {{ form.get('sessionDescription')?.value?.length || 0 }}/5000 caracteres
              </div>
            </div>
          </div>

          <!-- Botones del formulario -->
          <div class="d-flex gap-2 mt-4">
            <button
              type="button"
              class="btn btn-success"
              (click)="saveSession()"
            >
              <i class="bi bi-check-circle-fill me-2"></i>
              Registrar Sesión
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              (click)="cancelEdit()"
            >
              <i class="bi bi-x-circle me-2"></i>
              Cancelar
            </button>
          </div>
          
          <!-- Advertencia sobre inmutabilidad -->
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <small>
              <strong>Importante:</strong> Una vez guardada, la sesión no podrá ser modificada ni eliminada.
              Verifique que toda la información sea correcta antes de guardar.
            </small>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Lista de sesiones existentes (más recientes primero) -->
  @if (sessionsCount() > 0) {
    <div class="sessions-list">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
          Sesiones Registradas 
          <span class="badge bg-primary rounded-pill ms-2">{{ sessionsCount() }}</span>
        </h5>
        <small class="text-muted">
          <i class="bi bi-sort-down me-1"></i>
          Más recientes primero
        </small>
      </div>
      @for (session of sessionsReversed(); track session.sessionNumber) {
        <div class="session-card card mb-3 session-locked">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="card-title mb-2">
                  <span class="badge bg-primary me-2">Sesión {{ session.sessionNumber }}</span>
                  {{ session.date }}  {{ session.time }}
                  <span class="badge bg-secondary ms-2">
                    <i class="bi bi-lock-fill"></i> Registrada
                  </span>
                </h6>
                
                <!-- Vista colapsada (resumen) -->
                @if (!isSessionExpanded(session.sessionNumber)) {
                  <p class="card-text mb-2">
                    <strong>Objetivos/Técnicas:</strong> {{ session.objectivesAndTechniques }}
                  </p>
                  <p class="card-text text-muted mb-0">
                    {{ getSessionSummary(session) }}
                  </p>
                }
                
                <!-- Vista expandida (detalles completos) -->
                @if (isSessionExpanded(session.sessionNumber)) {
                  <div class="session-details-expanded">
                    <div class="detail-section">
                      <span class="detail-label">
                        <i class="bi bi-bullseye"></i>
                        Objetivos / Técnicas - Instrumentos
                      </span>
                      <div class="detail-content">{{ session.objectivesAndTechniques }}</div>
                    </div>
                    
                    <div class="detail-section">
                      <span class="detail-label">
                        <i class="bi bi-journal-text"></i>
                        Descripción de la Sesión
                      </span>
                      <div class="detail-content">{{ session.sessionDescription }}</div>
                    </div>
                  </div>
                }
              </div>
              
              <!-- Botón para expandir/colapsar -->
              <button
                type="button"
                class="btn btn-sm btn-outline-info ms-3"
                (click)="toggleSessionDetails(session.sessionNumber)"
              >
                @if (isSessionExpanded(session.sessionNumber)) {
                  <i class="bi bi-chevron-up me-1"></i>
                  Ocultar
                } @else {
                  <i class="bi bi-eye me-1"></i>
                  Ver Detalles
                }
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Mensaje si no hay sesiones -->
  @if (sessionsCount() === 0 && !showForm()) {
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      No hay sesiones registradas aún. Haga clic en el botón para registrar la primera sesión.
    </div>
  }
</div>

